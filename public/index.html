<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <title>DMH Tracker</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .bottom-spacer { height: 120px; }
      h1 { color: #800020; }
      .muted { color: #666; }
      .abbr { color: #555; font-weight: 500; }
      h2 { margin-bottom: 6px; }
      .subtitle { margin-top: 0; margin-bottom: 12px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 1200px; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
      .legend { display: flex; align-items: center; gap: 8px; margin: 6px 0 14px; color: #333; }
      .legend-swatch { width: 14px; height: 14px; border-radius: 3px; background: rgba(46, 160, 67, 0.10); border: 1px solid rgba(46, 160, 67, 0.35); }
      canvas { max-width: 100%; }
      code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <h1>DMH Tracker</h1>

    <h2>CBC and Differential</h2>
    <p class="subtitle" style="color:#333">MyHealth Labs: February 1, 2025 – February 1, 2026</p>
    <div class="legend"><span class="legend-swatch"></span><span>Reference Range</span></div>
    <div class="grid">
      <div class="row">
        <div class="card">
          <h2>PLT <span class="abbr">(Platelets)</span></h2>
          <canvas id="plt"></canvas>
        </div>
        <div class="card">
          <h2>WBC <span class="abbr">(White Blood Cells)</span></h2>
          <canvas id="wbc"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>Hgb <span class="abbr">(Hemoglobin)</span></h2>
          <canvas id="hgb"></canvas>
        </div>
        <div class="card">
          <h2>ANC <span class="abbr">(Absolute Neutrophil Count)</span></h2>
          <canvas id="anc"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>RBC <span class="abbr">(Red Blood Cells)</span></h2>
          <canvas id="rbc"></canvas>
        </div>
        <div class="card">
          <h2>Hct <span class="abbr">(Hematocrit)</span></h2>
          <canvas id="hct"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>MCV <span class="abbr">(Mean Corpuscular Volume)</span></h2>
          <canvas id="mcv"></canvas>
        </div>
        <div class="card">
          <h2>RDW <span class="abbr">(Red Cell Distribution Width)</span></h2>
          <canvas id="rdw"></canvas>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

    <script>
      const normalRangePlugin = {
        id: 'normalRangePlugin',
        beforeDraw(chart, args, opts) {
          const { ctx, chartArea, scales } = chart;
          const y = scales.y;
          if (!y || opts == null) return;

          const lo = opts.low;
          const hi = opts.high;
          if (typeof lo !== 'number' || typeof hi !== 'number') return;
          if (!Number.isFinite(lo) || !Number.isFinite(hi)) return;

          const yHi = y.getPixelForValue(hi);
          const yLo = y.getPixelForValue(lo);

          // Clamp to chart area so we never paint into axis labels.
          const top = Math.max(chartArea.top, Math.min(yHi, yLo));
          const bottom = Math.min(chartArea.bottom, Math.max(yHi, yLo));
          if (bottom <= top) return;

          ctx.save();
          ctx.fillStyle = opts.fill || 'rgba(46, 160, 67, 0.10)';
          ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top);
          ctx.restore();
        }
      };

      function getRefRange(points) {
        // Prefer a full low+high reference range.
        for (const p of points) {
          if (typeof p.refLow === 'number' && typeof p.refHigh === 'number') {
            return { low: p.refLow, high: p.refHigh };
          }
        }

        // Fall back to one-sided ranges (e.g. "<16.0") by inferring the other bound.
        for (const p of points) {
          if (typeof p.refHigh === 'number') {
            // For things like RDW (%), a lower bound of 0 is reasonable.
            return { low: 0, high: p.refHigh };
          }
          if (typeof p.refLow === 'number') {
            const maxVal = Math.max(...points.map(x => Number(x.value)).filter(Number.isFinite));
            return { low: p.refLow, high: Number.isFinite(maxVal) ? maxVal : null };
          }
        }

        return { low: null, high: null };
      }

      function mkChart(id, label, points) {
        const canvas = document.getElementById(id);
        const labels = points.map(p => p.date);
        const values = points.map(p => p.value);
        const rr = getRefRange(points);

        return new Chart(canvas, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label,
              data: values,
              borderColor: '#0b63ce',
              backgroundColor: 'rgba(11, 99, 206, 0.08)',
              tension: 0.2,
              pointRadius: 2,
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: 'category',
                ticks: { maxTicksLimit: 12 },
              },
              y: { beginAtZero: false },
            },
            plugins: {
              legend: { display: false },
              normalRangePlugin: { low: rr.low, high: rr.high }
            }
          },
          plugins: [normalRangePlugin]
        });
      }

      async function run() {
        const statusEl = document.createElement('p');
        statusEl.className = 'muted';
        statusEl.id = 'status';
        statusEl.textContent = 'Loading data…';
        document.body.insertAdjacentElement('afterbegin', statusEl);

        const res = await fetch('/biomarkers.json', { cache: 'no-store' });
        const json = await res.json();
        const points = (json.points ?? []);
        const generatedAt = json.generatedAt ? new Date(json.generatedAt) : null;
        const generatedAtText = (generatedAt && !Number.isNaN(generatedAt.getTime()))
          ? generatedAt.toLocaleString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })
          : 'Unknown';

        const by = {};
        for (const p of points) {
          (by[p.name] ||= []).push(p);
        }
        for (const k of Object.keys(by)) by[k].sort((a,b) => a.date.localeCompare(b.date));

        statusEl.innerHTML = `Last Updated: ${generatedAtText}<br/>Loaded ${points.length} points. (Platelets: ${(by.Platelets||[]).length}, WBC: ${(by.WBC||[]).length}, Hemoglobin: ${(by.Hemoglobin||[]).length}, ANC: ${(by.ANC||[]).length}, RBC: ${(by.RBC||[]).length}, Hct: ${(by.Hematocrit||[]).length}, MCV: ${(by.MCV||[]).length}, RDW: ${(by.RDW||[]).length})`;

        mkChart('plt', 'Platelets', by.Platelets ?? []);
        mkChart('wbc', 'WBC', by.WBC ?? []);
        mkChart('hgb', 'Hemoglobin', by.Hemoglobin ?? []);
        mkChart('anc', 'ANC', by.ANC ?? []);
        mkChart('rbc', 'RBC', by.RBC ?? []);
        mkChart('hct', 'Hematocrit', by.Hematocrit ?? []);
        mkChart('mcv', 'MCV', by.MCV ?? []);
        mkChart('rdw', 'RDW', by.RDW ?? []);
      }

      run().catch(err => {
        console.error(err);
        document.body.insertAdjacentHTML('beforeend', `<p style="color:red">Failed to load charts: ${String(err)}</p>`);
      });
    </script>

    <div class="bottom-spacer"></div>
  </body>
</html>
