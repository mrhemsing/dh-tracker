<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <title>DMH Tracker</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .bottom-spacer { height: 60px; }
      h1 { color: #800020; }
      .muted { color: #666; }
      .abbr { color: #555; font-weight: 500; }
      h2 { margin-bottom: 6px; }
      .subtitle { margin-top: 0; margin-bottom: 12px; }
      .subtitle-desktop { display: inline; }
      .subtitle-mobile { display: none; }

      /* Mobile tweaks */
      @media (max-width: 600px) {
        .abbr { font-size: 0.9em; }
        #status { font-size: 0.92em; }
        #status .loaded-line { display: inline-block; margin-top: 6px; }
        .subtitle-desktop { display: none; }
        .subtitle-mobile { display: inline; }
        .bottom-spacer { height: 30px; }
      }
      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 1200px; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
      .legend { display: flex; align-items: center; gap: 16px; margin: 6px 0 14px; color: #333; }
      .legend-item { display: inline-flex; align-items: center; gap: 8px; }
      .legend-swatch { width: 14px; height: 14px; border-radius: 3px; }
      .legend-swatch.ref { background: rgba(46, 160, 67, 0.10); border: 1px solid rgba(46, 160, 67, 0.35); }
      .legend-dot { width: 10px; height: 10px; border-radius: 999px; background: rgba(220, 38, 38, 0.95); display: inline-block; }
      .gap-note { margin-top: 12px; color: #444; }
      .gap-arrow { display: inline-block; vertical-align: -2px; margin: 0 3px; }
      .gap-arrow svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2.6; fill: none; }
      canvas { max-width: 100%; }
      code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <h1>DMH Tracker</h1>

    <h2>CBC and Differential</h2>
    <p class="subtitle" style="color:#333">
      <span class="subtitle-desktop">MyHealth Labs: February 1, 2025 – February 1, 2026</span>
      <span class="subtitle-mobile">MyHealth Labs: Feb 1, 2025 – Feb 1, 2026</span>
    </p>
    <div class="legend">
      <span class="legend-item"><span class="legend-swatch ref"></span><span>Reference Range</span></span>
      <span class="legend-item"><span class="legend-dot"></span><span>Critical (per report)</span></span>
    </div>
    <div class="grid" id="chart-grid">
      <div class="row">
        <div class="card">
          <h2>PLT <span class="abbr">(Platelets)</span></h2>
          <canvas id="plt"></canvas>
        </div>
        <div class="card">
          <h2>WBC <span class="abbr">(White Blood Cells)</span></h2>
          <canvas id="wbc"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>Hgb <span class="abbr">(Hemoglobin)</span></h2>
          <canvas id="hgb"></canvas>
        </div>
        <div class="card">
          <h2>ANC <span class="abbr">(Absolute Neutrophil Count)</span></h2>
          <canvas id="anc"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>RBC <span class="abbr">(Red Blood Cells)</span></h2>
          <canvas id="rbc"></canvas>
        </div>
        <div class="card">
          <h2>Hct <span class="abbr">(Hematocrit)</span></h2>
          <canvas id="hct"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>MCV <span class="abbr">(Mean Corpuscular Volume)</span></h2>
          <canvas id="mcv"></canvas>
        </div>
        <div class="card">
          <h2>RDW <span class="abbr">(Red Cell Dist. Width)</span></h2>
          <canvas id="rdw"></canvas>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

    <script>
      const normalRangePlugin = {
        id: 'normalRangePlugin',
        beforeDraw(chart, args, opts) {
          const { ctx, chartArea, scales } = chart;
          const y = scales.y;
          if (!y || opts == null) return;

          const lo = opts.low;
          const hi = opts.high;
          if (typeof lo !== 'number' || typeof hi !== 'number') return;
          if (!Number.isFinite(lo) || !Number.isFinite(hi)) return;

          const yHi = y.getPixelForValue(hi);
          const yLo = y.getPixelForValue(lo);

          // Clamp to chart area so we never paint into axis labels.
          const top = Math.max(chartArea.top, Math.min(yHi, yLo));
          const bottom = Math.min(chartArea.bottom, Math.max(yHi, yLo));
          if (bottom <= top) return;

          // Reference range
          ctx.save();
          ctx.fillStyle = opts.fill || 'rgba(46, 160, 67, 0.10)';
          ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top);
          ctx.restore();
        }
      };

      function getRefRange(points) {
        // Prefer a full low+high reference range.
        for (const p of points) {
          if (typeof p.refLow === 'number' && typeof p.refHigh === 'number') {
            return { low: p.refLow, high: p.refHigh };
          }
        }

        // Fall back to one-sided ranges (e.g. "<16.0") by inferring the other bound.
        for (const p of points) {
          if (typeof p.refHigh === 'number') {
            // For things like RDW (%), a lower bound of 0 is reasonable.
            return { low: 0, high: p.refHigh };
          }
          if (typeof p.refLow === 'number') {
            const maxVal = Math.max(...points.map(x => Number(x.value)).filter(Number.isFinite));
            return { low: p.refLow, high: Number.isFinite(maxVal) ? maxVal : null };
          }
        }

        return { low: null, high: null };
      }

      function mkChart(id, label, points) {
        const canvas = document.getElementById(id);
        const labels = points.map(p => p.date);
        const values = points.map(p => p.value);
        const rr = getRefRange(points);

        const firstDate = points.length ? points[0].date : null;
        const pointRadius = points.map(p => (p.date === firstDate ? 4 : (p.isCritical ? 4 : 2)));
        const pointBg = points.map(p => (
          p.date === firstDate
            ? '#14532d' // dark green
            : (p.isCritical ? 'rgba(220, 38, 38, 0.95)' : '#0b63ce')
        ));

        return new Chart(canvas, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label,
              data: values,
              borderColor: '#0b63ce',
              backgroundColor: 'rgba(11, 99, 206, 0.08)',
              tension: 0.2,
              pointRadius,
              pointBackgroundColor: pointBg,
            }]
          },
          options: {
            responsive: true,
            animation: {
              duration: 1400,
              easing: 'easeInOutQuart'
            },
            transitions: {
              active: { animation: { duration: 400 } },
              resize: { animation: { duration: 0 } },
            },
            scales: {
              x: {
                type: 'category',
                ticks: {
                  maxTicksLimit: 12,
                  color: (ctx) => (ctx.tick && ctx.tick.label === firstDate ? '#14532d' : '#666'),
                  font: (ctx) => (ctx.tick && ctx.tick.label === firstDate ? { weight: '700' } : {}),
                },
              },
              y: { beginAtZero: false },
            },
            plugins: {
              legend: { display: false },
              normalRangePlugin: { low: rr.low, high: rr.high }
            }
          },
          plugins: [normalRangePlugin]
        });
      }

      async function run() {
        const statusEl = document.createElement('p');
        statusEl.className = 'muted';
        statusEl.id = 'status';
        statusEl.textContent = 'Loading data…';
        document.body.insertAdjacentElement('afterbegin', statusEl);

        // Reserve a spot for the "first gap" note under the charts.
        const gapNoteEl = document.createElement('div');
        gapNoteEl.className = 'gap-note';
        gapNoteEl.id = 'gap-note';

        const res = await fetch('/biomarkers.json', { cache: 'no-store' });
        const json = await res.json();
        const points = (json.points ?? []);
        const isMobile = window.matchMedia && window.matchMedia('(max-width: 600px)').matches;

        // "Last Updated" should reflect the most recent report date we have in the dataset,
        // not when the website was deployed.
        const allDates = Array.from(new Set(points.map(p => p.date))).sort();
        const lastReportIso = allDates.length ? allDates[allDates.length - 1] : null;
        const lastReportDate = lastReportIso ? new Date(lastReportIso + 'T00:00:00') : null;
        const lastUpdatedText = (lastReportDate && !Number.isNaN(lastReportDate.getTime()))
          ? lastReportDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: isMobile ? 'short' : 'long',
              day: 'numeric'
            })
          : 'Unknown';

        const by = {};
        for (const p of points) {
          (by[p.name] ||= []).push(p);
        }
        for (const k of Object.keys(by)) by[k].sort((a,b) => a.date.localeCompare(b.date));

        if (isMobile) {
          statusEl.innerHTML = `Last Updated: ${lastUpdatedText}<br><span class="loaded-line">Loaded ${points.length} pts. (PLT: ${(by.Platelets||[]).length}, WBC: ${(by.WBC||[]).length}, Hgb: ${(by.Hemoglobin||[]).length}, ANC: ${(by.ANC||[]).length}, RBC: ${(by.RBC||[]).length}, Hct: ${(by.Hematocrit||[]).length}, MCV: ${(by.MCV||[]).length}, RDW: ${(by.RDW||[]).length})</span>`;
        } else {
          statusEl.innerHTML = `Last Updated: ${lastUpdatedText}<br/>Loaded ${points.length} points. (Platelets: ${(by.Platelets||[]).length}, WBC: ${(by.WBC||[]).length}, Hemoglobin: ${(by.Hemoglobin||[]).length}, ANC: ${(by.ANC||[]).length}, RBC: ${(by.RBC||[]).length}, Hct: ${(by.Hematocrit||[]).length}, MCV: ${(by.MCV||[]).length}, RDW: ${(by.RDW||[]).length})`;
        }

        mkChart('plt', 'Platelets', by.Platelets ?? []);
        mkChart('wbc', 'WBC', by.WBC ?? []);
        mkChart('hgb', 'Hemoglobin', by.Hemoglobin ?? []);
        mkChart('anc', 'ANC', by.ANC ?? []);
        mkChart('rbc', 'RBC', by.RBC ?? []);
        mkChart('hct', 'Hematocrit', by.Hematocrit ?? []);
        mkChart('mcv', 'MCV', by.MCV ?? []);
        mkChart('rdw', 'RDW', by.RDW ?? []);

        // Highlight the very first large gap (global across all points).
        const uniqueDates = Array.from(new Set(points.map(p => p.date))).sort();
        if (uniqueDates.length >= 2) {
          const d0 = new Date(uniqueDates[0]);
          const d1 = new Date(uniqueDates[1]);
          const gapDays = Math.round((d1 - d0) / (1000 * 60 * 60 * 24));

          if (Number.isFinite(gapDays) && gapDays >= 90) {
            const arrowSvg = `<span class="gap-arrow" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M5 12h12"/><path d="M13 6l6 6-6 6"/></svg></span>`;
            gapNoteEl.innerHTML = `<b>Data gap:</b> ${uniqueDates[0]} ${arrowSvg} ${uniqueDates[1]} (${gapDays} days)`;
            const grid = document.getElementById('chart-grid');
            if (grid && grid.parentElement) {
              grid.parentElement.insertBefore(gapNoteEl, grid.nextSibling);
            }
          }
        }
      }

      run().catch(err => {
        console.error(err);
        document.body.insertAdjacentHTML('beforeend', `<p style="color:red">Failed to load charts: ${String(err)}</p>`);
      });
    </script>

    <div class="bottom-spacer"></div>
  </body>
</html>
